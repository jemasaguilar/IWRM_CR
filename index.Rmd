# CHIRPS data download and basic manipulation reference guide

## Elaborated by: Juan Miguel VÃ­quez, Daniel Knopp & Jorge Masis
[GitHub repository link](https://github.com/jmviquez)

The following guide will include reference for:

 - Processing previously downloaded precipitation data from CHIRPS, within RStudio
 - Spatial data analysis
 - Ideas for graphs for data representation
 - Processed information download

## Plotting CHIRPS data for a river basin
### 1. Install the required packages

```{r}
	#install.packages("terra")
	#install.packages("rasterVis")
```

Terra is used for raster and vector spatial data analysis. 
[More info on Terra](https://cran.r-project.org/web/packages/terra/index.html)

### 2. Load the packages in the Rstudio session

```{r}
	library(rasterVis)
	library(terra)
```

### 3. Create the path for the Chirps dataset

This is the directory in the PC where Chirps is stored, change it to
your computer's directory, accordingly. 
If you are using *.tiff* files:

```{r}
	path_tiff <- "E:/Thao/chirps_monthly"
```
Or if you are using an *netcdf* file:

```{r}
  path_nc <-"D:/chirps-v2.0.monthly.nc"
```

### 4. Read the files 
If using *.tiff* files, is needed to read the names of these files and create a list() from them:
```{r}
	Chirps_files <- list.files(path_tiff,
                           pattern = NULL,
                           all.files = FALSE,
                           full.names = TRUE)
head(Chirps_files)
```

When using *netcdf* files, the only requirement is to read it ([info on NC files](https://www.unidata.ucar.edu/software/netcdf/)):

```{r}
	chirps<-rast(path_nc)
```

### 5. Create a stack

This step would be required for **.tiff files only**, more information on stacks can be found [here](https://r-spatial.github.io/stars/).
```{r}
    chirps <- rast(Chirps_files)
chirps
```

A raster stack has 3 dimensions (X, Y, Time), each of the rasters have the monthly average precipitation and each of the pixels within these rasters contains the precipitation value on the location for that month.
For plotting the data, since the stack has 3 dimensions, using *variablename\[\[\]\]* will provide access to a specific time:

```{r}
    plot(chirps[[1]])
```
### 6. Loading the Area of Interest
Given that CHIRPS is a global product, it is recommended to crop the area to the study region. In order to do this, a Shapefile is used as a "cookie cutter" to extract only the data within the area of interest (AOI). 
To load a shapefile the *vect()* function from the terra package is used **(*be aware of only using the .shp file and not the others ending on .shx or any other extension*)**:

```{r}
    Aguan_basin_path <- "E:/Basin_Rapel/Aguan/Cuenca_Rio_Aguan.shp"
    Aguan_basin <- vect(Aguan_basin_path)
    plot(Aguan_basin)
```

#### Adjusting the reference system

If the *crs* of the stack and the SHP do not match, the shapefile can be reprojected to the coordinates system of the raster. This can be checked with:

```{r}
chirps
```

```{r}
Aguan_basin
```

If there is a discrepancy between both coordinate systems, the *project()* function is used (more info [here](https://rdrr.io/cran/terra/man/project.html)):

```{r}
  Aguan_basin<-project(Aguan_basin,"+proj=longlat +datum=WGS84")
Aguan_basin
```

### 7. Cut to the AOI

For this, two functions are needed. The first one is the *crop()* function (more info [here](https://rdrr.io/cran/terra/man/crop.html)):

```{r}
    chirps_crop <- crop(chirps, Aguan_basin, snap = 'out')
chirps_crop
```

Plot the data:

```{r}
plot(chirps_crop[[1]])
lines(Aguan_basin)
```

The second function is *mask()*, this one eliminates any NA's resulting from the crop. ***(Always crop first and mask second, otherwise you will try to mask the whole extend of the datasheet and it takes a lot of processing and thus time)***

```{r}
    chirps_aguan <- mask(chirps_crop, Aguan_basin)
    plot(chirps_aguan[[1]])
    lines(Aguan_basin)    
```

### 8. Get a monthly average plot and monthly string

With *tapp()*, an average is extracted from the cropped raster stack, for the index time period. In order to get the monthly average an *index=1:12* is used and this way the names of the months to the raster layer can be assigned:

```{r}
    monthly_chirps<-tapp(chirps_aguan, index = 1:12, fun = mean)
    names(monthly_chirps)<-c('Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec')
monthly_chirps
```

Next, using a *levelplot* fthe monthly averages are ploted for the AOI (see more info [here](https://www.rdocumentation.org/packages/lattice/versions/0.10-10/topics/levelplot))

```{r}
    levelplot( monthly_chirps,layout=c(4,3),contour=T,col.regions=hcl.colors(100))
```

## Extract mean precipitation

This takes the already cropped and masked stack, for extracting the values inside a specific shapefile. It is done with the *extract()* function and *fun* is the treatment applied to the extraction, it can be the mean but also the min, max, sum or even a created function (more on functions, [here](https://swcarpentry.github.io/r-novice-inflammation/02-func-R/)):

```{r}
    extracted_values <- extract(chirps_aguan,Aguan_basin, fun = "mean")
extracted_values[1:10]
```

The list is transformed into a *dataframe* and then transposed, this way it is set into a *date/value* format, the first line is avoided, as it corresponds to the row's name:

```{r}
extracted_values <- as.numeric(extracted_values[2:481])
values <- as.data.frame(extracted_values)
head(values)
```

Following this, vectors are created for each month in the time series. The file's name is used for this (using this as an example "chirps-v2.0.2020.09.tif") the characters 13-19 are selected, which correspond to "2020.09" from the file's name and that is used to create a vector (the code below does that for all months):

```{r}
    Dates <- substr(basename(Chirps_files), 13, 19)
head(Dates)
```

The next step is to attach the dates and the *extracted_values* in a table:

```{r}
    Precipitation_Aguan <- cbind(Dates, values)
head(Precipitation_Aguan) 
```

## Artificial stations using CHIRPS

By creating a *points layer*, values can be extracted for specific locations within the basin. 
#### 1. Create a table 
Initially, a table of *X (lon)* and *Y (lat)* coordinates is created and then with the function *vect()* a point vector is created.
Make sure the coordinate system of reference is also on WGS84.
[Always remember.](C:/Users/jmviq/OneDrive/Documents/GitHub/IWRM_CR/21Maps.jpg)

```{r}
xy <- cbind(c(-87.000,-86.500,-86.000),c(15.202,15.403,15.800))
p <- vect(xy, crs="+proj=longlat +datum=WGS84")
plot(Aguan_basin)
points(p)
```

#### 2. Extract several points from a raster stack
Since the coordinates of the points of interest have been set, the next steps is to extract the values for the point layer. 
**Note: The extract function can also use other functions (max,min,sum)**

```{r}
extracted_values_points <- extract(chirps_aguan, p, fun = "mean")
```

Crop the index row, so that the first one from the data frame is eliminated. Following the same procedure:

```{r}
values_points <- (as.data.frame(extracted_values_points[2:481]))
Dates <- substr(basename(Chirps_files), 13, 19)
values_points[,10]
```
#### 3: Creating a data frame for the extracted values 
Now, once again it is required to transpose the rows with the columns, in order to create a table and then bind the rows with the *Dates vector*:

```{r}
Precipitation_Aguan<-t(rbind(Dates,values_points))
Precipitation_Aguan<-as.data.frame(Precipitation_Aguan)
head(Precipitation_Aguan)
```

#### 4. Assigning the headers 
With this part of the code, the headers for the table are assigned:

```{r}
colnames(Precipitation_Aguan)<-c('date','lower','middle','upper') 
head(Precipitation_Aguan)
```

#### 5. Saving it as a CSV file 
For this, *write.csv()* is used. 
**Note: Add the file extension of the format to the file name**

```{r}
write.csv(Precipitation_Aguan,"E:/Basin_Rapel/Cuenca_Aguan.csv")
```
## Plotting the data frame
#### 1. Add a path to the CSV file: 
```{r}
rapel <- "C:/Users/dknopp/Desktop/UCR/Excel/Cuenca_Aguan.csv"
```
#### 2. Open the CSV file:
```{r}
rapel_csv <- read.csv(rapel)
```
#### 3. Additional pre-processing of the data
Normally, 90% of the time we have to spend a little longer getting the information on the correct format for visualization. 
On this case, if plotting the *rapel_csv* as it is, there is an extra column which is not needed. This could either be ignored or a new data frame excluding that column can be created.
```{r}
df <- data.frame(rapel_csv$date, rapel_csv$lower, rapel_csv$middle, rapel_csv$upper)
```
The headers can also be renamed with *colnames()*:
```{r}
colnames(df) <- c("date", "lower" , "middle" , "upper")
```
#### 4. Plot the information
With the data frame ready, it is possible to plot it:
```{r}
plot(df$date, df$lower, type="l")
lines(df$date, df$middle, type="l", color="red")
```
Basic plot functions in R can be used, but there are packages that use CSS or Javascript with additional styling and interaction. For example, *ggplot2* and *dygraph* which can create interactives plots.
### Plotting with "dygraphs"
#### 1. The library is called:
```{r}
library(dygraphs)
```
With this package all the columns of the data frame are already recognized. Then the following functions here below are for improve and highlight more information from the plot:
```{r}
dygraph(df) %>% dyRangeSelector()
title
dygraph(df, main = "Descarga de Aquan") %>% dyRangeSelector()
```
Additional functions:
```{r}
dySeries()
dygraph(df, main = "Aguan") %>% dyRangeSelector() %>%
  dySeries("lower", label = "Lower", color ="green") %>%
  dySeries("middle", label = "Middle", color = "black") %>%
  dySeries("upper", label = "Upper", color = "red")
```
It is possible to stack the plots, fill the background, change the shape of each point and other options (more info about dyOptions, [here](https://www.rdocumentation.org/packages/dygraphs/versions/1.1.1.6/topics/dyOptions)):
```{r}
dygraph(df, main = "Aguan") %>% dyRangeSelector() %>%
  dySeries("lower", label = "Lower", color ="green") %>%
  dySeries("middle", label = "Middle", color = "black") %>%
  dySeries("upper", label = "Upper", color = "red") %>%
  dyOptions(stackedGraph = TRUE, pointShape = c("square"))
```
It is possible when the mouse is over the graph, to highlight the series: 
```{r}
dygraph(df, main = "Aguan") %>% dyRangeSelector() %>%
  dySeries("lower", label = "Lower", color ="green") %>%
  dySeries("middle", label = "Middle", color = "black") %>%
  dySeries("upper", label = "Upper", color = "red") %>%
  dyOptions(stackedGraph = TRUE) %>%
  dyRangeSelector(height = 20) %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))
```
And finally add titles to the axis:
```{r}
dygraph(df, main = "Aguan") %>% dyRangeSelector() %>%
  dySeries("lower", label = "Lower", color ="green") %>%
  dySeries("middle", label = "Middle", color = "black") %>%
  dySeries("upper", label = "Upper", color = "red") %>%
  dyOptions(stackedGraph = TRUE) %>%
  dyRangeSelector(height = 20) %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyAxis("y", label = "Descarga") %>%
  dyAxis("x", label ="Fecha")
```
The *dygraph* package can be read, for more information.
